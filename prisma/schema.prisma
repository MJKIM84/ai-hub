generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model Service {
  id           String   @id @default(cuid())
  slug         String   @unique
  url          String   @unique
  name         String
  description  String?
  tagline      String?
  logoUrl      String?
  faviconUrl   String?
  ogImageUrl   String?

  category     String
  tags         String   @default("[]")
  pricingModel String   @default("free")

  clicks       Int      @default(0)
  upvotes      Int      @default(0)
  downvotes    Int      @default(0)
  score        Float    @default(0)

  isVerified   Boolean  @default(false)
  isKorean     Boolean  @default(false)
  submittedBy  String?
  source       String   @default("user") // "user" | "auto" | "developer"

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  reviews        Review[]
  votes          Vote[]
  comments       Comment[]
  discoveryLogs  DiscoveryLog[]
  editRequests   EditRequest[]

  @@index([category])
  @@index([score])
  @@index([createdAt])
  @@index([isKorean])
  @@index([source])
}

model Review {
  id         String   @id @default(cuid())
  serviceId  String
  service    Service  @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  rating     Int
  content    String?
  authorName String?

  createdAt  DateTime @default(now())

  @@index([serviceId])
}

model Vote {
  id        String   @id @default(cuid())
  serviceId String
  service   Service  @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  voterIp   String
  type      String

  createdAt DateTime @default(now())

  @@unique([serviceId, voterIp, type])
  @@index([serviceId])
}

// ─── 커뮤니티 시스템 ───

model Comment {
  id           String   @id @default(cuid())
  serviceId    String
  service      Service  @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  content      String
  authorName   String
  authorIp     String
  likes        Int      @default(0)
  dislikes     Int      @default(0)

  createdAt    DateTime @default(now())

  commentVotes CommentVote[]

  @@index([serviceId])
  @@index([createdAt])
}

model CommentVote {
  id         String   @id @default(cuid())
  commentId  String
  comment    Comment  @relation(fields: [commentId], references: [id], onDelete: Cascade)
  voterIp    String
  type       String   // "like" | "dislike"

  createdAt  DateTime @default(now())

  @@unique([commentId, voterIp, type])
  @@index([commentId])
}

// ─── 자동 수집 시스템 ───

model DiscoverySource {
  id          String    @id @default(cuid())
  name        String    // "Product Hunt", "Hacker News" 등
  type        String    // "producthunt" | "hackernews" | "github" | "theresanai"
  url         String    @unique
  selector    String    @default("{}") // JSON: 소스별 파싱 설정
  isActive    Boolean   @default(true)
  priority    Int       @default(0)
  lastCrawled DateTime?

  logs        DiscoveryLog[]

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([isActive, priority])
}

model DiscoveryLog {
  id             String   @id @default(cuid())
  sourceId       String
  source         DiscoverySource @relation(fields: [sourceId], references: [id], onDelete: Cascade)

  discoveredUrl  String
  normalizedUrl  String   @unique
  domain         String

  title          String?
  description    String?

  status         String   @default("pending") // "pending" | "approved" | "rejected" | "duplicate" | "error"
  duplicateOfId  String?  // 중복 대상 Service ID
  duplicateOf    Service? @relation(fields: [duplicateOfId], references: [id], onDelete: SetNull)
  serviceId      String?  // 승인 후 생성된 Service ID (미사용 — discoveryLogs 관계로 추적)

  similarityScore Float?
  errorMessage    String?

  createdAt      DateTime @default(now())

  @@index([sourceId])
  @@index([status])
  @@index([domain])
}

model EditRequest {
  id           String   @id @default(cuid())
  serviceId    String
  service      Service  @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  requestType  String   // "claim" | "edit"
  contactEmail String
  verifyToken  String   @unique @default(cuid())
  isVerified   Boolean  @default(false)

  changes      String   @default("{}") // JSON: 변경 요청 내용
  reason       String?
  status       String   @default("pending") // "pending" | "approved" | "rejected"
  adminNote    String?

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([serviceId])
  @@index([status])
}

model CrawlRun {
  id              String    @id @default(cuid())
  startedAt       DateTime  @default(now())
  completedAt     DateTime?
  status          String    @default("running") // "running" | "completed" | "failed"

  sourcesChecked  Int       @default(0)
  urlsDiscovered  Int       @default(0)
  urlsNew         Int       @default(0)
  urlsDuplicate   Int       @default(0)
  servicesCreated Int       @default(0)

  errorMessage    String?

  @@index([startedAt])
}
